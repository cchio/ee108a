module midi_dynamics_tb();

    reg clk, reset, update, update_all, generate_next;
    reg [15:0] controller_values, note_values;
    wire [15:0] sample_in, sample_out;
    wire sample_ready, sample_out_ready, voice_on;
    wire [5:0] note;
    wire [19:0] step_size;

    midi_dynamics dynamics (
        .clk(clk),
        .reset(reset),
        .update_voice(update),
        .update_all_voices(update_all),
        .generate_next(generate_next),
        .controller_values(controller_values),
        .note_values(note_values),
        .sample_ready(sample_ready),
        .sample_in(sample_in),
        .voice_on(voice_on),
        .note(note),
        .sample_out_ready(sample_out_ready),
        .sample_out(sample_out)
    );

    frequency_rom freq_rom (
        .clk(clk),
        .addr(note),
        .dout(step_size)
    );

    sine_reader sine (
        .clk(clk),
        .reset(reset),
        .step_size(step_size),
        .zero(~voice_on),
        .generate_next(generate_next),
        .sample_ready(sample_ready),
        .sample(sample_in)
    );

    // clocking and resets
    initial begin
        clk = 1'b0;
        reset = 1'b1;
        repeat(4) #5 clk = ~clk;
        reset = 1'b0;
        forever #5 clk = ~clk;
    end

    // generate next
    initial begin
        generate_next = 1'b0;
        @(negedge reset);
        @(negedge clk);
        forever begin
            #100;
            @(negedge clk);
            generate_next = 1'b1;
            @(negedge clk);
            generate_next = 1'b0;
        end
    end

    // tests
    integer delay;
    initial begin
        delay = 64000000;
        controller_values = 16'b0;
        note_values = 16'h7F40;
        update = 1'b0;
        update_all = 1'b0;
        @(negedge reset);
        @(negedge clk);
        update = 1'b1;
        @(negedge clk);
        update = 1'b0;
        repeat(delay) begin
              @(negedge clk);
        end
        @(negedge clk);
        update = 1'b1;
        @(negedge clk);
        update = 1'b0;
        repeat(delay/3) begin
            @(negedge clk);
        end
        note_values = 16'h0040;
        update = 1'b1;
        @(negedge clk);
        update = 1'b0;
        repeat(delay/12) begin
            @(negedge clk);
        end
        @(negedge clk);
        note_values = 16'h3C40;
        controller_values = 16'h7F40;
        update = 1'b1;
        @(negedge clk);
        update = 1'b0;
        repeat(delay/3) begin
            @(negedge clk);
        end
        @(negedge clk);
        update_all = 1'b1;
        @(negedge clk);
        update_all = 1'b0;
        repeat(delay*2/3) begin
            @(negedge clk);
        end

        $finish;
    end

endmodule
